#####################################################################
# GROK FILTER FOR PROVIDED LOG FORMATS
#
# Handles:
#  - application.log  (Java INFO logs)
#  - error.log        (Java ERROR + multiline stack trace)
#  - audit.log        (AUDIT logs)
#  - access.log       (NGINX / Tomcat style access logs)
#
# Multiline handling for error logs is already done by Filebeat.
#####################################################################

filter {

  ###################################################################
  # 1️⃣ APPLICATION.LOG (INFO logs)
  #
  # Example:
  # 2025-12-14 09:23:28,930 INFO  [http-nio-8080-exec-5]
  # c.e.user.UserService - Successfully fetched user id=42
  ###################################################################
  if [log][file][path] =~ "application.log" {

    grok {
      match => {
        "message" => [
          "%{TIMESTAMP_ISO8601:log_timestamp} %{LOGLEVEL:level}\s+\[%{DATA:thread}\]\s+%{DATA:logger}\s+-\s+%{GREEDYDATA:msg}"
        ]
      }
      tag_on_failure => ["_grok_application_failure"]
    }

    date {
      match => ["log_timestamp", "YYYY-MM-dd HH:mm:ss,SSS"]
    }

    mutate {
      add_field => {
        "log_type" => "application"
      }
    }
  }

  ###################################################################
  # 2️⃣ ERROR.LOG (ERROR logs with stack traces)
  #
  # Example:
  # 2025-12-14 09:23:29,931 ERROR [thread] logger - message
  #   Traceback...
  ###################################################################
  else if [log][file][path] =~ "error.log" {

    grok {
      match => {
        "message" => [
          "%{TIMESTAMP_ISO8601:log_timestamp} %{LOGLEVEL:level}\s+\[%{DATA:thread}\]\s+%{DATA:logger}\s+-\s+%{GREEDYDATA:error_message}"
        ]
      }
      tag_on_failure => ["_grok_error_failure"]
    }

    date {
      match => ["log_timestamp", "YYYY-MM-dd HH:mm:ss,SSS"]
    }

    mutate {
      add_field => {
        "log_type" => "error"
      }
    }
  }

  ###################################################################
  # 3️⃣ AUDIT.LOG (Security / compliance logs)
  #
  # Example:
  # 2025-12-14 09:29:08,924 INFO  AUDIT User admin logged in from 192.0.2.185
  ###################################################################
  else if [log][file][path] =~ "audit.log" {

    grok {
      match => {
        "message" => [
          "%{TIMESTAMP_ISO8601:log_timestamp} %{LOGLEVEL:level}\s+AUDIT %{GREEDYDATA:audit_message}"
        ]
      }
      tag_on_failure => ["_grok_audit_failure"]
    }

    date {
      match => ["log_timestamp", "YYYY-MM-dd HH:mm:ss,SSS"]
    }

    mutate {
      add_field => {
        "log_type" => "audit"
      }
    }
  }

  ###################################################################
  # 4️⃣ ACCESS.LOG (HTTP access logs)
  #
  # Example:
  # 203.0.113.155 - - [14/Mar/2025:14:12:01 +0000]
  # "GET /api/v1/users/42 HTTP/1.1" 200 830 130
  ###################################################################
  else if [log][file][path] =~ "access.log" {

    grok {
      match => {
        "message" => [
          "%{IP:client_ip} - - \[%{HTTPDATE:access_time}\] \"%{WORD:method} %{URIPATH:path} HTTP/%{NUMBER:http_version}\" %{INT:status} %{INT:bytes} %{INT:latency_ms}"
        ]
      }
      tag_on_failure => ["_grok_access_failure"]
    }

    date {
      match => ["access_time", "dd/MMM/yyyy:HH:mm:ss Z"]
    }

    mutate {
      add_field => {
        "log_type" => "access"
      }
    }
  }

  ###################################################################
  # 5️⃣ CLEANUP (ALL LOGS)
  #
  # - Remove raw message after parsing
  # - Remove intermediate timestamp fields
  ###################################################################
  mutate {
    remove_field => ["message", "log_timestamp", "access_time"]
  }
}

mutate {
  convert => {
    "bytes" => "integer"
    "status" => "integer"
    "latency_ms" => "integer"
    "http_version" => "float"
  }
}
